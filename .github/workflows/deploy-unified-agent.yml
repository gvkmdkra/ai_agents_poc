name: Deploy Unified Agent to EC2

on:
  push:
    branches:
      - calling_agent_by_claude_version1
      - main
    paths:
      - 'unified_agent/**'
      - '.github/workflows/deploy-unified-agent.yml'
  workflow_dispatch:

env:
  EC2_HOST: 15.156.116.91
  EC2_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/poc/agents/unified_agent

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory on EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "sudo mkdir -p /home/ubuntu/poc/agents/unified_agent && sudo chown -R ubuntu:ubuntu /home/ubuntu/poc"

      - name: Copy application files to EC2
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/ec2_key.pem" \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude 'venv' \
            --exclude 'data' \
            --exclude 'logs' \
            --exclude 'node_modules' \
            --exclude '.next' \
            unified_agent/ \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Setup environment file
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "cd /home/ubuntu/poc/agents/unified_agent && if [ ! -f .env ]; then cp .env.example .env && echo 'Created .env from example'; fi"

      - name: Install Docker if needed
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "command -v docker || (curl -fsSL https://get.docker.com | sudo sh && sudo usermod -aG docker ubuntu)"

      - name: Install Docker Compose if needed
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "command -v docker-compose || sudo curl -L 'https://github.com/docker/compose/releases/latest/download/docker-compose-Linux-x86_64' -o /usr/local/bin/docker-compose && sudo chmod +x /usr/local/bin/docker-compose"

      - name: Stop ALL existing containers (including old calling_agent)
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "sudo docker stop \$(sudo docker ps -q) 2>/dev/null || true && sudo docker rm \$(sudo docker ps -aq) 2>/dev/null || true && cd /home/ubuntu/poc/agents/unified_agent && sudo docker-compose down 2>/dev/null || true && cd /home/ubuntu/poc/agents/calling_agent && sudo docker-compose down 2>/dev/null || true && sudo docker-compose -f docker-compose.scalable.yml down 2>/dev/null || true"

      - name: Build and start containers
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "cd /home/ubuntu/poc/agents/unified_agent && sudo docker-compose build --no-cache && sudo docker-compose up -d"

      - name: Wait for startup
        run: sleep 45

      - name: Health check
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "curl -s http://localhost:8000/health | grep -q healthy && echo 'API is healthy!' || (echo 'API health check failed' && sudo docker-compose -f /home/ubuntu/poc/agents/unified_agent/docker-compose.yml logs --tail=50)"

      - name: Configure Nginx
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} 'command -v nginx && echo "server { listen 80; server_name api.reapdat.com; location / { proxy_pass http://localhost:8000; proxy_http_version 1.1; proxy_set_header Upgrade \$http_upgrade; proxy_set_header Connection upgrade; proxy_set_header Host \$host; proxy_set_header X-Real-IP \$remote_addr; proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto \$scheme; } } server { listen 80; server_name app.reapdat.com; location / { proxy_pass http://localhost:3000; proxy_http_version 1.1; proxy_set_header Upgrade \$http_upgrade; proxy_set_header Connection upgrade; proxy_set_header Host \$host; proxy_set_header X-Real-IP \$remote_addr; proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto \$scheme; } }" | sudo tee /etc/nginx/sites-available/unified-agent && sudo ln -sf /etc/nginx/sites-available/unified-agent /etc/nginx/sites-enabled/ && sudo nginx -t && sudo systemctl reload nginx || echo "Nginx not installed, skipping"'

      - name: Verify deployment
        run: |
          echo "Checking application health..."
          curl -f http://${{ env.EC2_HOST }}:8000/health || echo "Direct health check - may need security group update"
          echo ""
          echo "========================================="
          echo "Deployment Complete!"
          echo "========================================="
          echo "API: http://${{ env.EC2_HOST }}:8000"
          echo "Dashboard: http://${{ env.EC2_HOST }}:3000"
          echo ""
          echo "For production, configure DNS:"
          echo "  api.reapdat.com -> ${{ env.EC2_HOST }}"
          echo "  app.reapdat.com -> ${{ env.EC2_HOST }}"
          echo "========================================="

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/ec2_key.pem
